name: Daily Papers Crawler

on:
  # å®šæ—¶æ‰§è¡Œï¼šæ¯å¤©åŒ—äº¬æ—¶é—´æ—©ä¸Š 7:30 (UTC 23:30)
  schedule:
    - cron: "30 23 * * *"

  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

  # æ¨é€åˆ° main åˆ†æ”¯æ—¶è§¦å‘ï¼ˆå¯é€‰ï¼Œç”¨äºæµ‹è¯•ï¼‰
  # push:
  #   branches: [ main ]

jobs:
  crawl-and-commit:
    runs-on: ubuntu-latest

    steps:
      # 1. æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. è®¾ç½® Go ç¯å¢ƒ
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23"
          cache: true

      # 3. ä¸‹è½½ä¾èµ–
      - name: Download dependencies
        run: go mod download

      # 4. è¿è¡Œçˆ¬è™« - äººæ°‘æ—¥æŠ¥
      - name: Crawl People's Daily (RMRB)
        run: go run cmd/main.go people -p rmrb,zgcsb,jksb,fcyym
        continue-on-error: true

      # 5. è·å–å½“å‰ä¸œå…«åŒºæ—¥æœŸ
      - name: Get current date
        id: date
        run: |
          DATE=$(TZ='Asia/Shanghai' date +'%Y%m%d')
          DATE_DISPLAY=$(TZ='Asia/Shanghai' date +'%Y-%m-%d')
          echo "date=$DATE" >> $GITHUB_OUTPUT
          echo "date_display=$DATE_DISPLAY" >> $GITHUB_OUTPUT

      # 6. æ£€æŸ¥æ˜¯å¦æœ‰ PDF æ–‡ä»¶ç”Ÿæˆ
      - name: Check for PDFs
        id: check_pdfs
        run: |
          if ls dist/${{ steps.date.outputs.date }}/*.pdf 1> /dev/null 2>&1; then
            echo "has_pdfs=true" >> $GITHUB_OUTPUT
          else
            echo "has_pdfs=false" >> $GITHUB_OUTPUT
          fi

      # 7. åˆ›å»º GitHub Release å¹¶ä¸Šä¼  PDF æ–‡ä»¶
      - name: Create Release and Upload PDFs
        if: steps.check_pdfs.outputs.has_pdfs == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: papers-${{ steps.date.outputs.date }}
          name: æŠ¥çº¸ PDF - ${{ steps.date.outputs.date_display }}
          body: |
            ## ğŸ“° æ¯æ—¥æŠ¥çº¸ PDF

            ç”Ÿæˆæ—¥æœŸï¼š${{ steps.date.outputs.date_display }}

            åŒ…å«ä»¥ä¸‹æŠ¥çº¸ï¼š
            - äººæ°‘æ—¥æŠ¥ (rmrb)
            - ä¸­å›½åŸå¸‚æŠ¥ (zgcsb)
            - å¥åº·æ—¶æŠ¥ (jksb)

            è¯·åœ¨ä¸‹æ–¹ Assets ä¸­ä¸‹è½½å¯¹åº”çš„ PDF æ–‡ä»¶ã€‚
          files: |
            dist/${{ steps.date.outputs.date }}/*.pdf
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # 8. ä¸Šä¼  artifactsï¼ˆå¯é€‰ï¼Œç”¨äºåœ¨ Actions é¡µé¢ä¸‹è½½ï¼‰
      - name: Upload PDFs as artifacts
        if: steps.check_pdfs.outputs.has_pdfs == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: daily-papers-${{ steps.date.outputs.date }}
          path: dist/${{ steps.date.outputs.date }}/*.pdf
          retention-days: 7
